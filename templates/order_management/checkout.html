{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - Everest Beauty{% endblock %}

{% block extra_css %}
<style>
    .checkout-container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-bottom: 30px;
    }
    
    .checkout-header {
        background: linear-gradient(135deg, var(--primary-color), #e91e63);
        color: white;
        padding: 25px 30px;
        text-align: center;
    }
    
    .checkout-header h1 {
        margin: 0;
        font-size: 2.2rem;
        font-weight: 700;
    }
    
    .checkout-header p {
        margin: 10px 0 0 0;
        opacity: 0.9;
        font-size: 1.1rem;
    }
    
    .checkout-steps {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 30px;
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
    }
    
    .step {
        display: flex;
        align-items: center;
        margin: 0 20px;
    }
    
    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e9ecef;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-right: 15px;
        transition: all 0.3s ease;
    }
    
    .step.active .step-number {
        background: var(--primary-color);
        color: white;
    }
    
    .step.completed .step-number {
        background: #28a745;
        color: white;
    }
    
    .step-text {
        font-weight: 600;
        color: #6c757d;
    }
    
    .step.active .step-text {
        color: var(--primary-color);
    }
    
    .step.completed .step-text {
        color: #28a745;
    }
    
    .step-divider {
        width: 60px;
        height: 2px;
        background: #e9ecef;
        margin: 0 10px;
    }
    
    .checkout-content {
        padding: 30px;
    }
    
    .form-section {
        margin-bottom: 40px;
    }
    
    .form-section h3 {
        color: var(--text-dark);
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--primary-color);
    }
    
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group.full-width {
        grid-column: 1 / -1;
    }
    
    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--text-dark);
    }
    
    .form-input {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    
    .form-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(233, 30, 99, 0.1);
    }
    
    .form-select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 1rem;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .form-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(233, 30, 99, 0.1);
    }
    
    .order-summary {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
    }
    
    .summary-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 20px;
        text-align: center;
    }
    
    .summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #e9ecef;
    }
    
    .summary-item:last-child {
        border-bottom: none;
    }
    
    .summary-item.total {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--primary-color);
        border-top: 2px solid var(--primary-color);
        padding-top: 15px;
        margin-top: 15px;
    }
    
    .payment-methods {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .payment-method {
        border: 2px solid #e9ecef;
        border-radius: 15px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }
    
    .payment-method:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
    }
    
    .payment-method.selected {
        border-color: var(--primary-color);
        background: rgba(233, 30, 99, 0.05);
    }
    
    .payment-method i {
        font-size: 2rem;
        color: var(--primary-color);
        margin-bottom: 10px;
    }
    
    .payment-method h5 {
        margin: 10px 0 5px 0;
        color: var(--text-dark);
    }
    
    .payment-method p {
        margin: 0;
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .checkout-actions {
        display: flex;
        gap: 20px;
        justify-content: space-between;
        align-items: center;
    }
    
    .btn-back {
        padding: 15px 30px;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 25px;
        font-size: 1.1rem;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
    }
    
    .btn-back:hover {
        background: #5a6268;
        color: white;
        text-decoration: none;
        transform: translateY(-2px);
    }
    
    .btn-place-order {
        padding: 18px 40px;
        background: linear-gradient(45deg, var(--primary-color), #e91e63);
        border: none;
        color: white;
        border-radius: 25px;
        font-size: 1.2rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(233, 30, 99, 0.3);
    }
    
    .btn-place-order:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(233, 30, 99, 0.4);
    }
    
    .btn-place-order:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    .delivery-options {
        margin-bottom: 30px;
    }
    
    .delivery-option {
        display: flex;
        align-items: center;
        padding: 15px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .delivery-option:hover {
        border-color: var(--primary-color);
    }
    
    .delivery-option.selected {
        border-color: var(--primary-color);
        background: rgba(233, 30, 99, 0.05);
    }
    
    .delivery-option input[type="radio"] {
        margin-right: 15px;
        transform: scale(1.2);
    }
    
    .delivery-option-details {
        flex: 1;
    }
    
    .delivery-option-title {
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 5px;
    }
    
    .delivery-option-description {
        color: #6c757d;
        font-size: 0.9rem;
        margin: 0;
    }
    
    .delivery-option-price {
        font-weight: 600;
        color: var(--primary-color);
    }
    
    .form-error {
        color: #dc3545;
        font-size: 0.9rem;
        margin-top: 5px;
    }
    
    .form-input.error {
        border-color: #dc3545;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    
    .loading-spinner {
        background: white;
        padding: 30px;
        border-radius: 15px;
        text-align: center;
    }
    
    .loading-spinner i {
        font-size: 2rem;
        color: var(--primary-color);
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'dashboard:home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'dashboard:cart' %}">Cart</a></li>
            <li class="breadcrumb-item active" aria-current="page">Checkout</li>
        </ol>
    </nav>

    <div class="checkout-container">
        <div class="checkout-header">
            <h1><i class="fas fa-credit-card"></i> Checkout</h1>
            <p>Complete your order and get ready for beautiful products!</p>
        </div>

        <div class="checkout-steps">
            <div class="step completed">
                <div class="step-number">1</div>
                <div class="step-text">Cart</div>
            </div>
            <div class="step-divider"></div>
            <div class="step active">
                <div class="step-number">2</div>
                <div class="step-text">Checkout</div>
            </div>
            <div class="step-divider"></div>
            <div class="step">
                <div class="step-number">3</div>
                <div class="step-text">Payment</div>
            </div>
        </div>

        <div class="checkout-content">
            <form id="checkout-form" method="POST">
                {% csrf_token %}
                
                <!-- Shipping Address -->
                <div class="form-section">
                    <h3><i class="fas fa-map-marker-alt"></i> Shipping Address</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="first_name" class="form-label">First Name *</label>
                            <input type="text" id="first_name" name="first_name" class="form-input" required 
                                   value="{{ user.first_name|default:'' }}">
                        </div>
                        <div class="form-group">
                            <label for="last_name" class="form-label">Last Name *</label>
                            <input type="text" id="last_name" name="last_name" class="form-input" required
                                   value="{{ user.last_name|default:'' }}">
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="phone" class="form-label">Phone Number *</label>
                        <input type="tel" id="phone" name="phone" class="form-input" required
                               value="{{ user.userprofile.phone|default:'' }}" placeholder="+977-XXXXXXXXX">
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="address" class="form-label">Street Address *</label>
                        <input type="text" id="address" name="address" class="form-input" required
                               placeholder="House/Street number, Street name">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="city" class="form-label">City *</label>
                            <input type="text" id="city" name="city" class="form-input" required
                                   placeholder="Kathmandu">
                        </div>
                        <div class="form-group">
                            <label for="postal_code" class="form-label">Postal Code</label>
                            <input type="text" id="postal_code" name="postal_code" class="form-input"
                                   placeholder="44600">
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="province" class="form-label">Province *</label>
                        <select id="province" name="province" class="form-select" required>
                            <option value="">Select Province</option>
                            <option value="Bagmati">Bagmati</option>
                            <option value="Gandaki">Gandaki</option>
                            <option value="Lumbini">Lumbini</option>
                            <option value="Karnali">Karnali</option>
                            <option value="Sudurpaschim">Sudurpaschim</option>
                            <option value="Province 1">Province 1</option>
                            <option value="Madhesh">Madhesh</option>
                        </select>
                    </div>
                </div>

                <!-- Delivery Options -->
                <div class="form-section">
                    <h3><i class="fas fa-truck"></i> Delivery Options</h3>
                    <div class="delivery-options">
                        <div class="delivery-option">
                            <input type="radio" id="standard" name="delivery_method" value="standard" checked>
                            <div class="delivery-option-details">
                                <div class="delivery-option-title">Standard Delivery</div>
                                <div class="delivery-option-description">3-5 business days</div>
                            </div>
                            <div class="delivery-option-price">
                                {% if cart.total_amount >= 1000 %}Free{% else %}Rs. 100{% endif %}
                            </div>
                        </div>
                        
                        <div class="delivery-option">
                            <input type="radio" id="express" name="delivery_method" value="express">
                            <div class="delivery-option-details">
                                <div class="delivery-option-title">Express Delivery</div>
                                <div class="delivery-option-description">1-2 business days</div>
                            </div>
                            <div class="delivery-option-price">Rs. 200</div>
                        </div>
                    </div>
                </div>

                <!-- Payment Method -->
                <div class="form-section">
                    <h3><i class="fas fa-credit-card"></i> Payment Method</h3>
                    <div class="payment-methods">
                        <div class="payment-method" onclick="selectPaymentMethod('khalti')">
                            <i class="fas fa-mobile-alt"></i>
                            <h5>Khalti</h5>
                            <p>Digital Wallet</p>
                        </div>
                        
                        <div class="payment-method" onclick="selectPaymentMethod('cod')">
                            <i class="fas fa-truck"></i>
                            <h5>Cash on Delivery</h5>
                            <p>Pay when you receive</p>
                        </div>
                    </div>
                    <input type="hidden" id="payment_method" name="payment_method" value="khalti">
                </div>

                <!-- Order Summary -->
                <div class="form-section">
                    <h3><i class="fas fa-shopping-bag"></i> Order Summary</h3>
                    <div class="order-summary">
                        <div class="summary-title">Your Order</div>
                        
                        {% for item in cart_items %}
                        <div class="summary-item d-flex align-items-center" id="checkout-item-{{ item.id }}">
                            <span style="flex:1;">
                                {{ item.product.name }}
                                <div class="item-quantity" style="display:inline-flex;align-items:center;gap:8px;margin-left:10px;">
                                    <button type="button" class="quantity-btn" onclick="updateCheckoutQuantity({{ item.id }}, -1)" style="width:28px;height:28px;font-size:1rem;"{% if item.quantity <= 1 %} disabled{% endif %}>
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input type="number" class="quantity-input" value="{{ item.quantity }}" min="1" max="10" onchange="updateCheckoutQuantity({{ item.id }}, 0, this.value)" style="width:38px;height:28px;text-align:center;font-size:1rem;">
                                    <button type="button" class="quantity-btn" onclick="updateCheckoutQuantity({{ item.id }}, 1)" style="width:28px;height:28px;font-size:1rem;"{% if item.quantity >= 10 %} disabled{% endif %}>
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </span>
                            <span class="mx-2" id="checkout-item-total-{{ item.id }}">Rs. {{ item.total_price }}</span>
                            <button type="button" class="remove-btn ms-2" onclick="removeFromCheckout({{ item.id }})" title="Remove item" style="font-size:1.1rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        {% endfor %}
                        
                        <div class="summary-item">
                            <span>Subtotal</span>
                            <span>Rs. {{ cart.subtotal }}</span>
                        </div>
                        
                        <div class="summary-item">
                            <span>Delivery Fee</span>
                            <span id="delivery-fee">
                                {% if cart.total_amount >= 1000 %}Free{% else %}Rs. 100{% endif %}
                            </span>
                        </div>
                        
                        <div class="summary-item total">
                            <span>Total</span>
                            <span id="order-total">Rs. {{ cart.total_amount }}</span>
                        </div>
                    </div>
                </div>

                <!-- Checkout Actions -->
                <div class="checkout-actions">
                    <a href="{% url 'dashboard:cart' %}" class="btn-back">
                        <i class="fas fa-arrow-left"></i> Back to Cart
                    </a>
                    
                    <button type="submit" class="btn-place-order" id="place-order-btn">
                        <i class="fas fa-lock"></i> Place Order
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay" style="display: none;">
    <div class="loading-spinner">
        <i class="fas fa-spinner"></i>
        <p>Processing your order...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedPaymentMethod = 'khalti';
    function selectPaymentMethod(method) {
        document.querySelectorAll('.payment-method').forEach(pm => {
            pm.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');
        document.getElementById('payment_method').value = method;
        selectedPaymentMethod = method;
    }
    document.querySelector('.payment-method').classList.add('selected');
    document.querySelectorAll('input[name="delivery_method"]').forEach(radio => {
        radio.addEventListener('change', function() {
            updateDeliveryFee();
        });
    });
    function updateDeliveryFee() {
        const deliveryMethod = document.querySelector('input[name="delivery_method"]:checked').value;
        const subtotal = {{ cart.subtotal }};
        let deliveryFee = 0;
        if (deliveryMethod === 'standard') {
            deliveryFee = subtotal >= 1000 ? 0 : 100;
        } else if (deliveryMethod === 'express') {
            deliveryFee = 200;
        }
        document.getElementById('delivery-fee').textContent = deliveryFee === 0 ? 'Free' : `Rs. ${deliveryFee}`;
        const total = subtotal + deliveryFee;
        document.getElementById('order-total').textContent = `Rs. ${total}`;
    }
    document.getElementById('checkout-form').addEventListener('submit', function(e) {
        e.preventDefault();
        if (validateForm()) {
            submitOrder();
        }
    });
    function validateForm() {
        let isValid = true;
        const requiredFields = ['first_name', 'last_name', 'phone', 'address', 'city', 'province'];
        document.querySelectorAll('.form-input.error').forEach(input => {
            input.classList.remove('error');
        });
        document.querySelectorAll('.form-error').forEach(error => {
            error.remove();
        });
        requiredFields.forEach(fieldName => {
            const field = document.getElementById(fieldName);
            if (!field.value.trim()) {
                field.classList.add('error');
                showFieldError(field, 'This field is required');
                isValid = false;
            }
        });
        const phone = document.getElementById('phone').value;
        if (phone && !/^(\+977)?[0-9]{10}$/.test(phone.replace(/\s/g, ''))) {
            document.getElementById('phone').classList.add('error');
            showFieldError(document.getElementById('phone'), 'Please enter a valid Nepali phone number');
            isValid = false;
        }
        return isValid;
    }
    function showFieldError(field, message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'form-error';
        errorDiv.textContent = message;
        field.parentNode.appendChild(errorDiv);
    }
    function submitOrder() {
        const submitBtn = document.getElementById('place-order-btn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        document.getElementById('loading-overlay').style.display = 'flex';
        const formData = new FormData(document.getElementById('checkout-form'));
        formData.append('cart_total', '{{ cart.total_amount }}');
        formData.append('delivery_method', document.querySelector('input[name="delivery_method"]:checked').value);
        fetch('/orders/checkout/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (selectedPaymentMethod === 'khalti') {
                    initiateKhalti(data.order_id);
                } else if (selectedPaymentMethod === 'cod') {
                    initiateCOD(data.order_id);
                }
            } else {
                showNotification(data.message || 'Failed to create order', 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-lock"></i> Place Order';
                document.getElementById('loading-overlay').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Failed to create order', 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-lock"></i> Place Order';
            document.getElementById('loading-overlay').style.display = 'none';
        });
    }
    function initiateCOD(orderId) {
        fetch('/payments/cod/initiate/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `order_id=${orderId}`
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                window.location.href = data.redirect_url;
            } else {
                showNotification(data.error || 'COD initiation failed', 'error');
            }
        })
        .catch(err => {
            console.error(err);
            showNotification('COD initiation failed', 'error');
        });
    }
    function initiateKhalti(orderId) {
        fetch('/payments/khalti/initiate/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `order_id=${orderId}`
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const khaltiKey = '{{ KHALTI_PUBLIC_KEY|default:"test_public_key" }}';
                const config = {
                    publicKey: khaltiKey,
                    productIdentity: String(orderId),
                    productName: 'Order Payment',
                    productUrl: window.location.origin,
                    eventHandler: {
                        onSuccess: function(payload) {
                            fetch('/payments/khalti/verify/', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ token: payload.token, amount: payload.amount, payment_id: data.payment_id })
                            })
                            .then(res => res.json())
                            .then(v => {
                                if (v.success) {
                                    window.location.href = `/payments/payment/success/${data.payment_id}/`;
                                } else {
                                    showNotification(v.error || 'Khalti verification failed', 'error');
                                }
                            });
                        },
                        onError: function(error) {
                            console.error(error);
                            showNotification('Khalti payment failed', 'error');
                        },
                        onClose: function() {
                            document.getElementById('loading-overlay').style.display = 'none';
                        }
                    }
                };
                if (window.KhaltiCheckout) {
                    const checkout = new KhaltiCheckout(config);
                    checkout.show({ amount: {{ cart.total_amount }} * 100 });
                } else {
                    showNotification('Khalti widget not loaded', 'error');
                }
            } else {
                showNotification(data.error || 'Khalti initiation failed', 'error');
            }
        })
        .catch(err => {
            console.error(err);
            showNotification('Khalti initiation failed', 'error');
        });
    }
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : type}`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            ${message}
        `;
        document.querySelector('.container').insertBefore(notification, document.querySelector('.checkout-container'));
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }

    // --- Cart item controls for checkout ---
    function updateCheckoutQuantity(itemId, change, newValue = null) {
        const itemElement = document.getElementById(`checkout-item-${itemId}`);
        const quantityInput = itemElement.querySelector('.quantity-input');
        const minusBtn = itemElement.querySelector('.quantity-btn:first-child');
        const plusBtn = itemElement.querySelector('.quantity-btn:last-child');
        let quantity;
        if (newValue !== null) {
            quantity = parseInt(newValue);
        } else {
            quantity = parseInt(quantityInput.value) + change;
        }
        if (quantity < 1) quantity = 1;
        if (quantity > 10) quantity = 10;
        quantityInput.value = quantity;
        minusBtn.disabled = quantity <= 1;
        plusBtn.disabled = quantity >= 10;
        fetch('/api/cart/update/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                item_id: itemId,
                quantity: quantity
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById(`checkout-item-total-${itemId}`).textContent = `Rs. ${data.item_total}`;
                updateCheckoutSummary(data.cart_total, data.subtotal);
                updateCartCount && updateCartCount();
                showNotification('Quantity updated successfully!', 'success');
            } else {
                showNotification(data.message || 'Failed to update quantity', 'error');
                quantityInput.value = data.original_quantity || 1;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Failed to update quantity', 'error');
        });
    }
    function removeFromCheckout(itemId) {
        if (!confirm('Are you sure you want to remove this item from your order?')) {
            return;
        }
        const itemElement = document.getElementById(`checkout-item-${itemId}`);
        itemElement.classList.add('loading');
        fetch('/api/cart/remove/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                item_id: itemId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                itemElement.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    itemElement.remove();
                    const remainingItems = document.querySelectorAll('.summary-item[id^="checkout-item-"]');
                    if (remainingItems.length === 0) {
                        location.reload();
                    }
                }, 300);
                updateCheckoutSummary(data.cart_total, data.subtotal);
                updateCartCount && updateCartCount();
                showNotification('Item removed from order successfully!', 'success');
            } else {
                showNotification(data.message || 'Failed to remove item', 'error');
                itemElement.classList.remove('loading');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Failed to remove item', 'error');
            itemElement.classList.remove('loading');
        });
    }
    function updateCheckoutSummary(cartTotal, subtotal) {
        document.getElementById('order-total').textContent = `Rs. ${cartTotal}`;
        if (subtotal !== undefined) {
            const subtotalElement = document.querySelector('.order-summary .summary-item:nth-last-child(3) span:last-child');
            if (subtotalElement) {
                subtotalElement.textContent = `Rs. ${subtotal}`;
            }
        }
    }
    // Add slideOut animation for item removal
    const style = document.createElement('style');
    style.textContent = `@keyframes slideOut { to { transform: translateX(100%); opacity: 0; } }`;
    document.head.appendChild(style);
</script>
{% endblock %}
